packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",a4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[m_,OptionsPattern[]]:=Module[{c,d,e,f,g,h,l,o,p,q,u,v,y,a6,z,a0,a1,a2,a20,a22,a5,a8,a9,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an,ao,ap,at,av,aw,ax,ay,az,aB,aD,aC,aI,aJ,aK,aR,aS,aU,b3,b4,b5,b6,b7,b8,b9,ba,bb,bc,bd,be,bf,bg,bh,bi,bj,bk,bl,bm,bn,bo,bp,i,j,k,n,s,t,aX,aF,aG,b1,b2,aH,aL,aM,aN,aQ,aT,aY,ar,aO,as,aP,aA,aW,aV,aD2,aZ,b0,aq},ab=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];at=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];t={False,True,False,False,True,False,True,False,False,True,False,True};aa[x_]:=If[StringContainsQ[x,"#"],ab[ToUpperCase[StringTake[x,2]]]+12*ToExpression[StringDrop[x,2]]-9,ab[ToUpperCase[StringTake[x,1]]]+12*ToExpression[StringDrop[x,1]]-9];aj[x_]:=at[Mod[x+9,12]]<>ToString[Floor[(x+9)/12]];ai[x_]:=OptionValue[a4Frequency]*2^((x-48)/12);ak[x_]:=t[[Mod[x,12]+1]];af=OptionValue[noteRange];ae=aa/@af;ah=OptionValue[noteStart];ag=aa[ah]+1;o[x_]:=1200.*Log[2,x];p[x_]:=12.*Log[2,x];bf=m;If[StringTake[m,-1]!="/",aO=True;Goto[as],aO=False];bm=Import[bf];ac=First[StringSplit[#,"."]]&/@bm;ad=If[LetterQ[StringTake[#,1]],aa[#],ToExpression[#]-ag]&/@ac;v=0.9;aw=0.05;ba=0.08;b5=10000;b7[x_]:=Which[x<40,17,x<60,13,True,8];bb=0.08;bh=0.8;bc=0.01;c[q_,r_]:=(b8=bg[[Round[q-bb*r];;Round[q+bb*r]]];a9=bb+bc;b9=bg[[Round[q-a9*r];;Round[q+a9*r]]];e=First@First@Position[b9[[;;,2]],Max[b8[[;;,2]]]];s=b9[[Round[e-bc*r];;Round[e+bc*r]]];s=Total[Table[s[[w,1]]*s[[w,2]],{w,Length[s]}]]/Total[Table[s[[w,2]],{w,Length[s]}]];s);am[x_]:=(bl=Import[bf<>bm[[x]],"Sound"];bk=ai[ad[[x]]];k=bl[[1,2]];be=Mean[bl[[1,1]]];be=be/Max[be];be=be[[First[First[Position[be,1.]]];;]];bo=Partition[be,Floor[ba*k]];bp=Length[bo];w=1;n={};While[Max[Abs[bo[[w]]]]>=v&&w<=bp;w++];While[Max[Abs[bo[[w]]]]>=aw&&w<=bp,AppendTo[n,bo[[w]]];w++];n=Flatten[n];b6=b7[ad[[x]]]+1;bg=Abs[Fourier[n]];bg=Table[{w*k/Length[n],bg[[w]]},{w,IntegerPart[Length[bg]/2]}];bd=Min[bk*b6,b5];bg=Select[bg,First[#]<bd&];bg=Table[{bg[[w,1]]/bk,bg[[w,2]]},{w,Length[bg]}];bn=bk/k*Length[n];bi=Round[bh*bn];j=First@First@Position[bg[[;;,2]],Max[bg[[bi;;,2]]]];i=bg[[j,1]];ao={};bj=j/Round[i];al=j/i;f=i;g=j;u=bj;ao=Union[Append[ao,c[g,u]]];While[g+u+(bb+bc)*u<Length[bg],q=g+u;d=c[q,u];u=Round[(d-f)*al];f=d;g=Round[d*al];ao=Union[Append[ao,d]];];If[Round[i]!=1,f=i;g=j;While[g-bj-(bb+bc)>bh*al,q=g-bj;d=c[q,al];f=d;g=Round[d*al];ao=Union[Prepend[ao,d]];]];ad[[x]]->ao);ap=Association[ParallelTable[am[w],{w,Length[ad]}]];Label[as];y=10^4;If[!aO,a20=SortBy[Table[l=ap[ad[[w]]];l=l/l[[1]];Clear[b,n];l=Table[{w-1,l[[w]]/w},{w,Length[l]}];Flatten@{ad[[w]],y*b/.FindFit[l,a*Sqrt[1+b*n^2],{{a,1},{b,0}},n]},{w,Length[ad]}],First];a2=Select[a20,Last[#]>0&];a2=Table[{a2[[w,1]],Log[a2[[w,2]]]},{w,Length[a2]}];h=OptionValue[deleteNotes];h=If[StringQ[#],aa[#],#-ag]&/@h;a2=Select[a2,!MemberQ[h,#[[1]]]&];aP=StringRiffle[Table[aj[a2[[w,1]]]<>"  "<>ToString[a2[[w,2]]],{w,Length[a2]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],aP,"Text"]],aP=Import[m,"Text"];aD=StringSplit[#]&/@StringSplit[aP,"\n"];a2=Table[{aa[aD[[w,1]]],ToExpression[aD[[w,2]]]},{w,Length[aD]}];];a0[a2_]:=(aD=a2[[;;,1]];av=Fit[Select[a2,#[[1]]<=15&],{1,x},x];av=(a2[[1,2]]-CoefficientList[av,x][[-1]]*a2[[1,1]])+CoefficientList[av,x][[-1]]*x;a8=Fit[Select[a2,#[[1]]>=40&],{1,x},x];a8=(a2[[-1,2]]-CoefficientList[a8,x][[-1]]*a2[[-1,1]])+CoefficientList[a8,x][[-1]]*x;a22=Flatten[{Table[{x,av},{x,ae[[1]]-100,aD[[1]]-1,12}],a2,Table[{x,a8},{x,aD[[-1]]+1,ae[[2]]+100,12}]},1];a5=Interpolation[a22];a1=Show[Plot[a5[k],{k,ae[[1]],ae[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[ak[a2[[w,1]]],Black,Pink],If[ak[a2[[w,1]]],PointSize[.006],PointSize[.008]],Point[a2[[w]]]},{w,Length[a2]}],Black,Table[Text[aj[a2[[w,1]]],{a2[[w,1]],a2[[w,2]]+0.3If[OddQ[a2[[w,1]]],1,-1]},Background->White],{w,Length[a2]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[w,{w,ae[[1]],ae[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightRed];a6[k_,n_]:=n*Sqrt[1+E^a5[k]/y*(n-1)^2];a6);z=a0[a2];aQ=16000;aU=OptionValue[polynomialOrder];b4=Table[ToExpression["X"<>ToString[w]],{w,aU}];Clear/@b4;b3[x_]=Expand[Total[Table[b4[[w]]*(x-aa["A4"])^w,{w,aU}]]];aR=OptionValue[tuningMethod];aX=OptionValue[tuningSplit];aR=Table[Sort[ToExpression[StringSplit[aR[[w]],":"]]],{w,Length[aR]}];aX=aa@aX;aF=aR[[1,2]]/aR[[1,1]];aG=p[aF];aH=Expand[Total[Table[an=o[z[a7,aR[[1,2]]]/z[a7+aG,aR[[1,1]]]/aF];(an-(b3[a7+aG]-b3[a7]))^2,{a7,ae[[1]],aX}]]];b1=aR[[2,2]]/aR[[2,1]];b2=p[b1];aL=Expand[Total[Table[an=o[z[a7-b2,aR[[2,2]]]/z[a7,aR[[2,1]]]/b1];(an-(b3[a7]-b3[a7-b2]))^2,{a7,aX+1,ae[[2]]}]]];aJ=aH+aL;aS=NMinimize[aJ,b4];aI[x_]=b3[x]/.(aS[[2]]);aK=Graphics[Flatten[{LightRed,Line[{{ae[[1]],0},{ae[[2]],0}}],Table[{If[Mod[x-3,12]==0,{GrayLevel[.4],Disk[{x,aI[x]},.6]}],If[ak[x],Black,If[x==48,Red,LightGray]],Disk[{x,aI[x]},If[ak[x],.22,.33]]},{x,ae[[1]],ae[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[w,{w,ae[[1]],ae[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];aM=-Flatten[{Table[an=o[z[a7,aR[[1,2]]]/z[a7+aG,aR[[1,1]]]/aF];(an-(b3[a7+aG]-b3[a7]))/.aS[[2]],{a7,ae[[1]],aX}],Table[an=o[z[a7-b2,aR[[2,2]]]/z[a7,aR[[2,1]]]/b1];(an-(b3[a7]-b3[a7-b2]))/.aS[[2]],{a7,aX+1,ae[[2]]}]}];aN=Graphics[Flatten[{LightRed,Line[{{ae[[1]],0},{ae[[2]],0}}],Table[{If[Mod[x-3,12]==0,{GrayLevel[.4],Disk[{x,aM[[x+1]]},.6]}],If[ak[x],Black,If[x==48,Red,LightGray]],Disk[{x,aM[[x+1]]},If[ak[x],.22,.33]]},{x,ae[[1]],ae[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[w,{w,ae[[1]],ae[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];aB=OptionValue[temperment];If[aB!="",If[!DirectoryQ[aB],aB=packageDirectory<>"../res/temperments/"<>aB<>".tem"];ax=Import[aB,"Text"];az=Map[StringSplit,StringSplit[ax,"\n"]];ay=SortBy[Union@Table[{ab[az[[w,1]]],az[[w,2]]},{w,Length[az]}],First][[;;,2]];ay=ToExpression/@ay;aC[ax_,x_]:=(aD=RotateRight[ay,ab[x]];aD-aD[[10]]);ay=aC[ay,OptionValue[tempermentMajor]];aD=RotateRight[ay,3];aA=Association[Table[w->aD[[w+1]],{w,0,11}]];,aA=Association[Table[w->0,{w,0,11}]];];aW[k_,n_]:=(ai[k]*2^((aI[k]+aA[Mod[k,12]])/1200)*z[k,n]);aV[k_,n_]:=Log[2,aW[k,n]/ai[k]/n]*1200;ar[x_]:=EmitSound[Play[Sin[2*Pi*t*x],{t,0,0.2},SampleRate->44100]];aT=Import[packageDirectory<>"params/"<>"tuning_partials"];aT=Association[Flatten[Table[aD=StringSplit[aT[[w,1]],"~"];If[aD[[1]]=="*",aD[[1]]=af[[1]]];If[aD[[2]]=="*",aD[[2]]=af[[2]]];aD=aa/@aD;Table[a7->aT[[w,2]],{a7,aD[[1]],aD[[2]]}],{w,Length[aT]}]]];aY=Framed[TableForm[Table[aD=aW[k,n];aD2=aV[k,n];aZ=ToString[aD];b0=If[aD2>0,"+",""]<>ToString[Ceiling[aD2,0.01]]<>"\[Cent]";If[aD2==0.,aZ="["<>ToString[aD]<>"Hz]";b0=""];If[aD>aQ,"",With[{au=aD},Button[Row[{Style[aZ,If[aD2==0,Blue,If[aT[k]==n,Red,Black]]],Style[b0,If[aT[k]==n,Pink,Gray],6]}],ar[au],Appearance->None]]],{k,ae[[1]],ae[[2]]},{n,1,16}],TableHeadings->{Table[aj[k],{k,ae[[1]],ae[[2]]}],Table[w,{w,1,16}]},TableSpacing->{.5,.3}]];aq=Framed[Column[{aK,aN,a1}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],aq];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],aY];];Column[{aY,Deploy[aq]}]]