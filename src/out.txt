packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",A4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[aE_,OptionsPattern[]]:=Module[{at,r,aH,ai,q,av,a0,am,aY,o,a5,bp,aW,b4,m,bo,bf,c,b9,bh,aM,af,aO,p,ah,bg,u,d,aq,aJ,b0,au,aw,a6,a9,b3,w,z,b7,k,aj,bn,aS,a4,ao,aa,e,b2,an,b1,i,g,aB,aX,l,aA,bl,bb,bc,j,aP,bd,a7,ac,b6,y,aZ,h,aQ,n,ar,ay,aC,aU,bj,ag,aL,ad,a8,az,a3,v,b5,a1,as,ae,ap,al,s,ba,aD,be,bm,a2,aI,bi,aT,b8,ax,aG,aF,bk,ak,aN,aR,aV},ah=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];k=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];b5={False,True,False,False,True,False,True,False,False,True,False,True};p[b_]:=If[StringContainsQ[b,"#"],ah[ToUpperCase[StringTake[b,2]]]+12*ToExpression[StringDrop[b,2]]-9,ah[ToUpperCase[StringTake[b,1]]]+12*ToExpression[StringDrop[b,1]]-9];aw[b_]:=k[Mod[b+9,12]]<>ToString[Floor[(b+9)/12]];au[b_]:=OptionValue[A4Frequency]*2^((b-48)/12);a6[b_]:=b5[[Mod[b,12]+1]];aq=OptionValue[noteRange];d=p/@aq;b0=OptionValue[noteStart];aJ=p[b0]+1;am[b_]:=1200.*Log[2,b];aY[b_]:=12.*Log[2,b];aZ=aE;If[StringTake[aE,-1]!="/",aT=True;Goto[b8],aT=False];aU=Import[aZ];bg=First[StringSplit[#,"."]]&/@aU;u=If[LetterQ[StringTake[#,1]],p[#],ToExpression[#]-aJ]&/@bg;bp=0.9;bn=0.05;bd=0.08;bl=10000;bc[b_]:=Which[b<40,17,b<60,13,True,8];a7=0.08;aQ=0.8;ac=0.01;at[o_,ab_]:=(j=h[[Round[o-a7*ab];;Round[o+a7*ab]]];aO=a7+ac;aP=h[[Round[o-aO*ab];;Round[o+aO*ab]]];aH=First@First@Position[aP[[;;,2]],Max[j[[;;,2]]]];v=aP[[Round[aH-ac*ab];;Round[aH+ac*ab]]];v=Total[Table[v[[a,1]]*v[[a,2]],{a,Length[v]}]]/Total[Table[v[[a,2]],{a,Length[v]}]];v);b3[b_]:=(aC=Import[aZ<>aU[[b]],"Sound"];ay=au[u[[b]]];az=aC[[1,2]];y=Mean[aC[[1,1]]];y=y/Max[y];y=y[[First[First[Position[y,1.]]];;]];ag=Partition[y,Floor[bd*az]];aL=Length[ag];a=1;a3={};While[Max[Abs[ag[[a]]]]>=bp&&a<=aL;a++];While[Max[Abs[ag[[a]]]]>=bn&&a<=aL,AppendTo[a3,ag[[a]]];a++];a3=Flatten[a3];bb=bc[u[[b]]]+1;h=Abs[Fourier[a3]];h=Table[{a*az/Length[a3],h[[a]]},{a,IntegerPart[Length[h]/2]}];b6=Min[ay*bb,bl];h=Select[h,First[#]<b6&];h=Table[{h[[a,1]]/ay,h[[a,2]]},{a,Length[h]}];bj=ay/az*Length[a3];n=Round[aQ*bj];a8=First@First@Position[h[[;;,2]],Max[h[[n;;,2]]]];ad=h[[a8,1]];z={};ar=a8/Round[ad];a9=a8/ad;ai=ad;q=a8;a5=ar;z=Union[Append[z,at[q,a5]]];While[q+a5+(a7+ac)*a5<Length[h],o=q+a5;r=at[o,a5];a5=Round[(r-ai)*a9];ai=r;q=Round[r*a9];z=Union[Append[z,r]];];If[Round[ad]!=1,ai=ad;q=a8;While[q-ar-(a7+ac)>aQ*a9,o=q-ar;r=at[o,a9];ai=r;q=Round[r*a9];z=Union[Prepend[z,r]];]];u[[b]]->z);b7=Association[ParallelTable[b3[a],{a,Length[u]}]];Label[b8];aW=10^4;If[!aT,b9=SortBy[Table[a0=b7[u[[a]]];a0=a0/a0[[1]];Clear[aK,n];a0=Table[{a-1,a0[[a]]/a},{a,Length[a0]}];Flatten@{u[[a]],aW*aK/.FindFit[a0,t*Sqrt[1+aK*n^2],{{t,1},{aK,0}},n]},{a,Length[u]}],First];c=Select[b9,Last[#]>0&];c=Table[{c[[a,1]],Log[c[[a,2]]]},{a,Length[c]}];av=OptionValue[deleteNotes];av=If[StringQ[#],p[#],#-aJ]&/@av;c=Select[c,!MemberQ[av,#[[1]]]&];ax=StringRiffle[Table[aw[c[[a,1]]]<>"  "<>ToString[c[[a,2]]],{a,Length[c]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],ax,"Text"]],ax=Import[aE,"Text"];e=StringSplit[#]&/@StringSplit[ax,"\n"];c=Table[{p[e[[a,1]]],ToExpression[e[[a,2]]]},{a,Length[e]}];];bo[c_]:=(e=c[[;;,1]];aj=Fit[Select[c,#[[1]]<=15&],{1,b},b];aj=(c[[1,2]]-CoefficientList[aj,b][[-1]]*c[[1,1]])+CoefficientList[aj,b][[-1]]*b;af=Fit[Select[c,#[[1]]>=40&],{1,b},b];af=(c[[-1,2]]-CoefficientList[af,b][[-1]]*c[[-1,1]])+CoefficientList[af,b][[-1]]*b;bh=Flatten[{Table[{b,aj},{b,d[[1]]-100,e[[1]]-1,12}],c,Table[{b,af},{b,e[[-1]]+1,d[[2]]+100,12}]},1];aM=Interpolation[bh];bf=Show[Plot[aM[k],{k,d[[1]],d[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[a6[c[[a,1]]],Black,Pink],If[a6[c[[a,1]]],PointSize[.006],PointSize[.008]],Point[c[[a]]]},{a,Length[c]}],Black,Table[Text[aw[c[[a,1]]],{c[[a,1]],c[[a,2]]+0.3If[OddQ[c[[a,1]]],1,-1]},Background->White],{a,Length[c]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightRed];b4[k_,n_]:=n*Sqrt[1+E^aM[k]/aW*(n-1)^2];b4);m=bo[c];bm=16000;aX=OptionValue[polynomialOrder];aA=Table[ToExpression["X"<>ToString[a]],{a,aX}];Clear/@aA;l[b_]=Expand[Total[Table[aA[[a]]*(b-p["A4"])^a,{a,aX}]]];g=OptionValue[tuningMethod];a1=OptionValue[tuningSplit];g=Table[Sort[ToExpression[StringSplit[g[[a]],":"]]],{a,Length[g]}];a1=p@a1;as=g[[1,2]]/g[[1,1]];ae=aY[as];s=Expand[Total[Table[w=am[m[f,g[[1,2]]]/m[f+ae,g[[1,1]]]/as];(w-(l[f+ae]-l[f]))^2,{f,d[[1]],a1}]]];ap=g[[2,2]]/g[[2,1]];al=aY[ap];ba=Expand[Total[Table[w=am[m[f-al,g[[2,2]]]/m[f,g[[2,1]]]/ap];(w-(l[f]-l[f-al]))^2,{f,a1+1,d[[2]]}]]];b1=s+ba;aB=NMinimize[b1,aA];an[b_]=l[b]/.(aB[[2]]);i=Graphics[Flatten[{LightRed,Line[{{d[[1]],0},{d[[2]],0}}],Table[{If[Mod[b-3,12]==0,{GrayLevel[.4],Disk[{b,an[b]},.6]}],If[a6[b],Black,If[b==48,Red,LightGray]],Disk[{b,an[b]},If[a6[b],.22,.33]]},{b,d[[1]],d[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];aD=-Flatten[{Table[w=am[m[f,g[[1,2]]]/m[f+ae,g[[1,1]]]/as];(w-(l[f+ae]-l[f]))/.aB[[2]],{f,d[[1]],a1}],Table[w=am[m[f-al,g[[2,2]]]/m[f,g[[2,1]]]/ap];(w-(l[f]-l[f-al]))/.aB[[2]],{f,a1+1,d[[2]]}]}];be=Graphics[Flatten[{LightRed,Line[{{d[[1]],0},{d[[2]],0}}],Table[{If[Mod[b-3,12]==0,{GrayLevel[.4],Disk[{b,aD[[b+1]]},.6]}],If[a6[b],Black,If[b==48,Red,LightGray]],Disk[{b,aD[[b+1]]},If[a6[b],.22,.33]]},{b,d[[1]],d[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];aa=OptionValue[temperment];If[aa!="",If[!DirectoryQ[aa],aa=packageDirectory<>"../res/temperments/"<>aa<>".tem"];aS=Import[aa,"Text"];ao=Map[StringSplit,StringSplit[aS,"\n"]];a4=SortBy[Union@Table[{ah[ao[[a,1]]],ao[[a,2]]},{a,Length[ao]}],First][[;;,2]];a4=ToExpression/@a4;b2[aS_,b_]:=(e=RotateRight[a4,ah[b]];e-e[[10]]);a4=b2[a4,OptionValue[tempermentMajor]];e=RotateRight[a4,3];aG=Association[Table[a->e[[a+1]],{a,0,11}]];,aG=Association[Table[a->0,{a,0,11}]];];aF[k_,n_]:=(au[k]*2^((an[k]+aG[Mod[k,12]])/1200)*m[k,n]);bk[k_,n_]:=Log[2,aF[k,n]/au[k]/n]*1200;bi[b_]:=EmitSound[Play[Sin[2*Pi*t*b],{t,0,0.2},SampleRate->44100]];a2=Import[packageDirectory<>"params/"<>"tuning_partials"];a2=Association[Flatten[Table[e=StringSplit[a2[[a,1]],"~"];If[e[[1]]=="*",e[[1]]=aq[[1]]];If[e[[2]]=="*",e[[2]]=aq[[2]]];e=p/@e;Table[f->a2[[a,2]],{f,e[[1]],e[[2]]}],{a,Length[a2]}]]];aI=Framed[TableForm[Table[e=aF[k,n];ak=bk[k,n];aN=ToString[e];aR=If[ak>0,"+",""]<>ToString[Ceiling[ak,0.01]]<>"\[Cent]";If[ak==0.,aN="["<>ToString[e]<>"Hz]";aR=""];If[e>bm,"",With[{x=e},Button[Row[{Style[aN,If[ak==0,Blue,If[a2[k]==n,Red,Black]]],Style[aR,If[a2[k]==n,Pink,Gray],6]}],bi[x],Appearance->None]]],{k,d[[1]],d[[2]]},{n,1,16}],TableHeadings->{Table[aw[k],{k,d[[1]],d[[2]]}],Table[a,{a,1,16}]},TableSpacing->{.5,.3}]];aV=Framed[Column[{i,be,bf}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],aV];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],aI];];Column[{aI,Deploy[aV]}]]