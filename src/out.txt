packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",A4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[h_,OptionsPattern[]]:=Module[{a,b,c,d,e,f,g,i,j,k,m,n,o,w,p,q,r,s,s0,s2,v,x,y,z,a0,a1,a2,a3,a4,a5,a6,a7,a8,a9,aa,ab,ac,ad,ae,ai,aj,ak,al,am,an,ap,ar,aq,aw,ax,ay,b5,b6,b8,bh,bi,bj,bk,bl,bm,bn,bo,bp,bq,br,bs,bt,bu,bv,bw,bx,by,bz,c0,c1,c2,c3,c4,c5,c6,c7,c8,c9,bb,at,au,bf,bg,av,az,b0,b1,b4,b7,bc,ag,b2,ah,b3,ao,ba,b9,ar2,bd,be,af},a0=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];ai=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];c9={False,True,False,False,True,False,True,False,False,True,False,True};z[x_]:=If[StringContainsQ[x,"#"],a0[ToUpperCase[StringTake[x,2]]]+12*ToExpression[StringDrop[x,2]]-9,a0[ToUpperCase[StringTake[x,1]]]+12*ToExpression[StringDrop[x,1]]-9];a8[x_]:=ai[Mod[x+9,12]]<>ToString[Floor[(x+9)/12]];a7[x_]:=OptionValue[A4Frequency]*2^((x-48)/12);a9[x_]:=c9[[Mod[x,12]+1]];a4=OptionValue[noteRange];a3=z/@a4;a6=OptionValue[noteStart];a5=z[a6]+1;i[x_]:=1200.*Log[2,x];j[x_]:=12.*Log[2,x];bt=h;If[StringTake[h,-1]!="/",b2=True;Goto[ah],b2=False];c0=Import[bt];a1=First[StringSplit[#,"."]]&/@c0;a2=If[LetterQ[StringTake[#,1]],z[#],ToExpression[#]-a5]&/@a1;n=0.9;ak=0.05;bo=0.08;bj=10000;bl[x_]:=Which[x<40,17,x<60,13,True,8];bp=0.08;bv=0.8;bq=0.01;a[k_,l_]:=(bm=bu[[Round[k-bp*l];;Round[k+bp*l]]];y=bp+bq;bn=bu[[Round[k-y*l];;Round[k+y*l]]];c=First@First@Position[bn[[;;,2]],Max[bm[[;;,2]]]];c8=bn[[Round[c-bq*l];;Round[c+bq*l]]];c8=Total[Table[c8[[i,1]]*c8[[i,2]],{i,Length[c8]}]]/Total[Table[c8[[i,2]],{i,Length[c8]}]];c8);ab[x_]:=(bz=Import[bt<>c0[[x]],"Sound"];by=a7[a2[[x]]];c6=bz[[1,2]];bs=Mean[bz[[1,1]]];bs=bs/Max[bs];bs=bs[[First[First[Position[bs,1.]]];;]];c2=Partition[bs,Floor[bo*c6]];c3=Length[c2];i=1;c7={};While[Max[Abs[c2[[i]]]]>=n&&i<=c3;i++];While[Max[Abs[c2[[i]]]]>=ak&&i<=c3,AppendTo[c7,c2[[i]]];i++];c7=Flatten[c7];bk=bl[a2[[x]]]+1;bu=Abs[Fourier[c7]];bu=Table[{i*c6/Length[c7],bu[[i]]},{i,IntegerPart[Length[bu]/2]}];br=Min[by*bk,bj];bu=Select[bu,First[#]<br&];bu=Table[{bu[[i,1]]/by,bu[[i,2]]},{i,Length[bu]}];c1=by/c6*Length[c7];bw=Round[bv*c1];c5=First@First@Position[bu[[;;,2]],Max[bu[[bw;;,2]]]];c4=bu[[c5,1]];ad={};bx=c5/Round[c4];aa=c5/c4;d=c4;e=c5;m=bx;ad=Union[Append[ad,a[e,m]]];While[e+m+(bp+bq)*m<Length[bu],k=e+m;b=a[k,m];m=Round[(b-d)*aa];d=b;e=Round[b*aa];ad=Union[Append[ad,b]];];If[Round[c4]!=1,d=c4;e=c5;While[e-bx-(bp+bq)>bv*aa,k=e-bx;b=a[k,aa];d=b;e=Round[b*aa];ad=Union[Prepend[ad,b]];]];a2[[x]]->ad);ae=Association[ParallelTable[ab[i],{i,Length[a2]}]];Label[ah];o=10^4;If[!b2,s0=SortBy[Table[g=ae[a2[[i]]];g=g/g[[1]];Clear[B,n];g=Table[{i-1,g[[i]]/i},{i,Length[g]}];Flatten@{a2[[i]],o*B/.FindFit[g,A*Sqrt[1+B*n^2],{{A,1},{B,0}},n]},{i,Length[a2]}],First];s=Select[s0,Last[#]>0&];s=Table[{s[[i,1]],Log[s[[i,2]]]},{i,Length[s]}];f=OptionValue[deleteNotes];f=If[StringQ[#],z[#],#-a5]&/@f;s=Select[s,!MemberQ[f,#[[1]]]&];b3=StringRiffle[Table[a8[s[[i,1]]]<>"  "<>ToString[s[[i,2]]],{i,Length[s]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],b3,"Text"]],b3=Import[h,"Text"];ar=StringSplit[#]&/@StringSplit[b3,"\n"];s=Table[{z[ar[[i,1]]],ToExpression[ar[[i,2]]]},{i,Length[ar]}];];q[s_]:=(ar=s[[;;,1]];aj=Fit[Select[s,#[[1]]<=15&],{1,x},x];aj=(s[[1,2]]-CoefficientList[aj,x][[-1]]*s[[1,1]])+CoefficientList[aj,x][[-1]]*x;x=Fit[Select[s,#[[1]]>=40&],{1,x},x];x=(s[[-1,2]]-CoefficientList[x,x][[-1]]*s[[-1,1]])+CoefficientList[x,x][[-1]]*x;s2=Flatten[{Table[{x,aj},{x,a3[[1]]-100,ar[[1]]-1,12}],s,Table[{x,x},{x,ar[[-1]]+1,a3[[2]]+100,12}]},1];v=Interpolation[s2];r=Show[Plot[v[k],{k,a3[[1]],a3[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[a9[s[[i,1]]],Black,Pink],If[a9[s[[i,1]]],PointSize[.006],PointSize[.008]],Point[s[[i]]]},{i,Length[s]}],Black,Table[Text[a8[s[[i,1]]],{s[[i,1]],s[[i,2]]+0.3If[OddQ[s[[i,1]]],1,-1]},Background->White],{i,Length[s]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[i,{i,a3[[1]],a3[[2]]}],Table[i,{i,-100,100}]},GridLinesStyle->LightRed];w[k_,n_]:=n*Sqrt[1+E^v[k]/o*(n-1)^2];w);p=q[s];b4=16000;b8=OptionValue[polynomialOrder];bi=Table[ToExpression["X"<>ToString[i]],{i,b8}];Clear/@bi;bh[x_]=Expand[Total[Table[bi[[i]]*(x-z["A4"])^i,{i,b8}]]];b5=OptionValue[tuningMethod];bb=OptionValue[tuningSplit];b5=Table[Sort[ToExpression[StringSplit[b5[[i]],":"]]],{i,Length[b5]}];bb=z@bb;at=b5[[1,2]]/b5[[1,1]];au=j[at];av=Expand[Total[Table[ac=i[p[j,b5[[1,2]]]/p[j+au,b5[[1,1]]]/at];(ac-(bh[j+au]-bh[j]))^2,{j,a3[[1]],bb}]]];bf=b5[[2,2]]/b5[[2,1]];bg=j[bf];az=Expand[Total[Table[ac=i[p[j-bg,b5[[2,2]]]/p[j,b5[[2,1]]]/bf];(ac-(bh[j]-bh[j-bg]))^2,{j,bb+1,a3[[2]]}]]];ax=av+az;b6=NMinimize[ax,bi];aw[x_]=bh[x]/.(b6[[2]]);ay=Graphics[Flatten[{LightRed,Line[{{a3[[1]],0},{a3[[2]],0}}],Table[{If[Mod[x-3,12]==0,{GrayLevel[.4],Disk[{x,aw[x]},.6]}],If[a9[x],Black,If[x==48,Red,LightGray]],Disk[{x,aw[x]},If[a9[x],.22,.33]]},{x,a3[[1]],a3[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[i,{i,a3[[1]],a3[[2]]}],Table[i,{i,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];b0=-Flatten[{Table[ac=i[p[j,b5[[1,2]]]/p[j+au,b5[[1,1]]]/at];(ac-(bh[j+au]-bh[j]))/.b6[[2]],{j,a3[[1]],bb}],Table[ac=i[p[j-bg,b5[[2,2]]]/p[j,b5[[2,1]]]/bf];(ac-(bh[j]-bh[j-bg]))/.b6[[2]],{j,bb+1,a3[[2]]}]}];b1=Graphics[Flatten[{LightRed,Line[{{a3[[1]],0},{a3[[2]],0}}],Table[{If[Mod[x-3,12]==0,{GrayLevel[.4],Disk[{x,b0[[x+1]]},.6]}],If[a9[x],Black,If[x==48,Red,LightGray]],Disk[{x,b0[[x+1]]},If[a9[x],.22,.33]]},{x,a3[[1]],a3[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[i,{i,a3[[1]],a3[[2]]}],Table[i,{i,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];ap=OptionValue[temperment];If[ap!="",If[!DirectoryQ[ap],ap=packageDirectory<>"../res/temperments/"<>ap<>".tem"];al=Import[ap,"Text"];an=Map[StringSplit,StringSplit[al,"\n"]];am=SortBy[Union@Table[{a0[an[[i,1]]],an[[i,2]]},{i,Length[an]}],First][[;;,2]];am=ToExpression/@am;aq[al_,x_]:=(ar=RotateRight[am,a0[x]];ar-ar[[10]]);am=aq[am,OptionValue[tempermentMajor]];ar=RotateRight[am,3];ao=Association[Table[i->ar[[i+1]],{i,0,11}]];,ao=Association[Table[i->0,{i,0,11}]];];ba[k_,n_]:=(a7[k]*2^((aw[k]+ao[Mod[k,12]])/1200)*p[k,n]);b9[k_,n_]:=Log[2,ba[k,n]/a7[k]/n]*1200;ag[x_]:=EmitSound[Play[Sin[2*Pi*t*x],{t,0,0.2},SampleRate->44100]];b7=Import[packageDirectory<>"params/"<>"tuning_partials"];b7=Association[Flatten[Table[ar=StringSplit[b7[[i,1]],"~"];If[ar[[1]]=="*",ar[[1]]=a4[[1]]];If[ar[[2]]=="*",ar[[2]]=a4[[2]]];ar=z/@ar;Table[j->b7[[i,2]],{j,ar[[1]],ar[[2]]}],{i,Length[b7]}]]];bc=Framed[TableForm[Table[ar=ba[k,n];ar2=b9[k,n];bd=ToString[ar];be=If[ar2>0,"+",""]<>ToString[Ceiling[ar2,0.01]]<>"\[Cent]";If[ar2==0.,bd="["<>ToString[ar]<>"Hz]";be=""];If[ar>b4,"",With[{s=ar},Button[Row[{Style[bd,If[ar2==0,Blue,If[b7[k]==n,Red,Black]]],Style[be,If[b7[k]==n,Pink,Gray],6]}],ag[s],Appearance->None]]],{k,a3[[1]],a3[[2]]},{n,1,16}],TableHeadings->{Table[a8[k],{k,a3[[1]],a3[[2]]}],Table[i,{i,1,16}]},TableSpacing->{.5,.3}]];af=Framed[Column[{ay,b1,r}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],af];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],bc];];Column[{bc,Deploy[af]}]]