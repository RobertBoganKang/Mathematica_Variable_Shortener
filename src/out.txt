packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",a4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[m_,OptionsPattern[]]:=Module[{c,d,e,f,g,h,l,o,p,q,u,v,y,J,z,C,D,F,F0,F2,I,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a0,a1,a2,a6,a8,a9,aa,ab,ac,ae,ag,af,al,am,an,au,av,ax,aG,aH,aI,aJ,aK,aL,aM,aN,aO,aP,aQ,aR,aS,aT,aU,aV,aW,aX,aY,aZ,i,j,k,n,s,t,x,A,B,aA,ai,aj,aE,aF,ak,ao,ap,aq,at,aw,aB,a4,ar,a5,as,ad,az,ay,ag2,aC,aD,a3},O=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];a6=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];B={False,True,False,False,True,False,True,False,False,True,False,True};N[E_]:=If[StringContainsQ[E,"#"],O[ToUpperCase[StringTake[E,2]]]+12*ToExpression[StringDrop[E,2]]-9,O[ToUpperCase[StringTake[E,1]]]+12*ToExpression[StringDrop[E,1]]-9];W[E_]:=a6[Mod[E+9,12]]<>ToString[Floor[(E+9)/12]];V[E_]:=OptionValue[a4Frequency]*2^((E-48)/12);X[E_]:=B[[Mod[E,12]+1]];S=OptionValue[noteRange];R=N/@S;U=OptionValue[noteStart];T=N[U]+1;o[E_]:=1200.*Log[2,E];p[E_]:=12.*Log[2,E];aS=m;If[StringTake[m,-1]!="/",ar=True;Goto[a5],ar=False];aZ=Import[aS];P=First[StringSplit[#,"."]]&/@aZ;Q=If[LetterQ[StringTake[#,1]],N[#],ToExpression[#]-T]&/@P;v=0.9;a9=0.05;aN=0.08;aI=10000;aK[E_]:=Which[E<40,17,E<60,13,True,8];aO=0.08;aU=0.8;aP=0.01;c[q_,r_]:=(aL=aT[[Round[q-aO*r];;Round[q+aO*r]]];M=aO+aP;aM=aT[[Round[q-M*r];;Round[q+M*r]]];e=First@First@Position[aM[[;;,2]],Max[aL[[;;,2]]]];A=aM[[Round[e-aP*r];;Round[e+aP*r]]];A=Total[Table[A[[w,1]]*A[[w,2]],{w,Length[A]}]]/Total[Table[A[[w,2]],{w,Length[A]}]];A);Z[E_]:=(aY=Import[aS<>aZ[[E]],"Sound"];aX=V[Q[[E]]];t=aY[[1,2]];aR=Mean[aY[[1,1]]];aR=aR/Max[aR];aR=aR[[First[First[Position[aR,1.]]];;]];j=Partition[aR,Floor[aN*t]];k=Length[j];w=1;x={};While[Max[Abs[j[[w]]]]>=v&&w<=k;w++];While[Max[Abs[j[[w]]]]>=a9&&w<=k,AppendTo[x,j[[w]]];w++];x=Flatten[x];aJ=aK[Q[[E]]]+1;aT=Abs[Fourier[x]];aT=Table[{w*t/Length[x],aT[[w]]},{w,IntegerPart[Length[aT]/2]}];aQ=Min[aX*aJ,aI];aT=Select[aT,First[#]<aQ&];aT=Table[{aT[[w,1]]/aX,aT[[w,2]]},{w,Length[aT]}];i=aX/t*Length[x];aV=Round[aU*i];s=First@First@Position[aT[[;;,2]],Max[aT[[aV;;,2]]]];n=aT[[s,1]];a1={};aW=s/Round[n];Y=s/n;f=n;g=s;u=aW;a1=Union[Append[a1,c[g,u]]];While[g+u+(aO+aP)*u<Length[aT],q=g+u;d=c[q,u];u=Round[(d-f)*Y];f=d;g=Round[d*Y];a1=Union[Append[a1,d]];];If[Round[n]!=1,f=n;g=s;While[g-aW-(aO+aP)>aU*Y,q=g-aW;d=c[q,Y];f=d;g=Round[d*Y];a1=Union[Prepend[a1,d]];]];Q[[E]]->a1);a2=Association[ParallelTable[Z[w],{w,Length[Q]}]];Label[a5];y=10^4;If[!ar,F0=SortBy[Table[l=a2[Q[[w]]];l=l/l[[1]];Clear[b,n];l=Table[{w-1,l[[w]]/w},{w,Length[l]}];Flatten@{Q[[w]],y*b/.FindFit[l,a*Sqrt[1+b*n^2],{{a,1},{b,0}},n]},{w,Length[Q]}],First];F=Select[F0,Last[#]>0&];F=Table[{F[[w,1]],Log[F[[w,2]]]},{w,Length[F]}];h=OptionValue[deleteNotes];h=If[StringQ[#],N[#],#-T]&/@h;F=Select[F,!MemberQ[h,#[[1]]]&];as=StringRiffle[Table[W[F[[w,1]]]<>"  "<>ToString[F[[w,2]]],{w,Length[F]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],as,"Text"]],as=Import[m,"Text"];ag=StringSplit[#]&/@StringSplit[as,"\n"];F=Table[{N[ag[[w,1]]],ToExpression[ag[[w,2]]]},{w,Length[ag]}];];C[F_]:=(ag=F[[;;,1]];a8=Fit[Select[F,#[[1]]<=15&],{1,E},E];a8=(F[[1,2]]-CoefficientList[a8,E][[-1]]*F[[1,1]])+CoefficientList[a8,E][[-1]]*E;L=Fit[Select[F,#[[1]]>=40&],{1,E},E];L=(F[[-1,2]]-CoefficientList[L,E][[-1]]*F[[-1,1]])+CoefficientList[L,E][[-1]]*E;F2=Flatten[{Table[{E,a8},{E,R[[1]]-100,ag[[1]]-1,12}],F,Table[{E,L},{E,ag[[-1]]+1,R[[2]]+100,12}]},1];I=Interpolation[F2];D=Show[Plot[I[k],{k,R[[1]],R[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[X[F[[w,1]]],Black,Pink],If[X[F[[w,1]]],PointSize[.006],PointSize[.008]],Point[F[[w]]]},{w,Length[F]}],Black,Table[Text[W[F[[w,1]]],{F[[w,1]],F[[w,2]]+0.3If[OddQ[F[[w,1]]],1,-1]},Background->White],{w,Length[F]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[w,{w,R[[1]],R[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightRed];J[k_,n_]:=n*Sqrt[1+E^I[k]/y*(n-1)^2];J);z=C[F];at=16000;ax=OptionValue[polynomialOrder];aH=Table[ToExpression["X"<>ToString[w]],{w,ax}];Clear/@aH;aG[E_]=Expand[Total[Table[aH[[w]]*(E-N["A4"])^w,{w,ax}]]];au=OptionValue[tuningMethod];aA=OptionValue[tuningSplit];au=Table[Sort[ToExpression[StringSplit[au[[w]],":"]]],{w,Length[au]}];aA=N@aA;ai=au[[1,2]]/au[[1,1]];aj=p[ai];ak=Expand[Total[Table[a0=o[z[K,au[[1,2]]]/z[K+aj,au[[1,1]]]/ai];(a0-(aG[K+aj]-aG[K]))^2,{K,R[[1]],aA}]]];aE=au[[2,2]]/au[[2,1]];aF=p[aE];ao=Expand[Total[Table[a0=o[z[K-aF,au[[2,2]]]/z[K,au[[2,1]]]/aE];(a0-(aG[K]-aG[K-aF]))^2,{K,aA+1,R[[2]]}]]];am=ak+ao;av=NMinimize[am,aH];al[E_]=aG[E]/.(av[[2]]);an=Graphics[Flatten[{LightRed,Line[{{R[[1]],0},{R[[2]],0}}],Table[{If[Mod[E-3,12]==0,{GrayLevel[.4],Disk[{E,al[E]},.6]}],If[X[E],Black,If[E==48,Red,LightGray]],Disk[{E,al[E]},If[X[E],.22,.33]]},{E,R[[1]],R[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[w,{w,R[[1]],R[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];ap=-Flatten[{Table[a0=o[z[K,au[[1,2]]]/z[K+aj,au[[1,1]]]/ai];(a0-(aG[K+aj]-aG[K]))/.av[[2]],{K,R[[1]],aA}],Table[a0=o[z[K-aF,au[[2,2]]]/z[K,au[[2,1]]]/aE];(a0-(aG[K]-aG[K-aF]))/.av[[2]],{K,aA+1,R[[2]]}]}];aq=Graphics[Flatten[{LightRed,Line[{{R[[1]],0},{R[[2]],0}}],Table[{If[Mod[E-3,12]==0,{GrayLevel[.4],Disk[{E,ap[[E+1]]},.6]}],If[X[E],Black,If[E==48,Red,LightGray]],Disk[{E,ap[[E+1]]},If[X[E],.22,.33]]},{E,R[[1]],R[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[w,{w,R[[1]],R[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];ae=OptionValue[temperment];If[ae!="",If[!DirectoryQ[ae],ae=packageDirectory<>"../res/temperments/"<>ae<>".tem"];aa=Import[ae,"Text"];ac=Map[StringSplit,StringSplit[aa,"\n"]];ab=SortBy[Union@Table[{O[ac[[w,1]]],ac[[w,2]]},{w,Length[ac]}],First][[;;,2]];ab=ToExpression/@ab;af[aa_,E_]:=(ag=RotateRight[ab,O[E]];ag-ag[[10]]);ab=af[ab,OptionValue[tempermentMajor]];ag=RotateRight[ab,3];ad=Association[Table[w->ag[[w+1]],{w,0,11}]];,ad=Association[Table[w->0,{w,0,11}]];];az[k_,n_]:=(V[k]*2^((al[k]+ad[Mod[k,12]])/1200)*z[k,n]);ay[k_,n_]:=Log[2,az[k,n]/V[k]/n]*1200;a4[E_]:=EmitSound[Play[Sin[2*Pi*t*E],{t,0,0.2},SampleRate->44100]];aw=Import[packageDirectory<>"params/"<>"tuning_partials"];aw=Association[Flatten[Table[ag=StringSplit[aw[[w,1]],"~"];If[ag[[1]]=="*",ag[[1]]=S[[1]]];If[ag[[2]]=="*",ag[[2]]=S[[2]]];ag=N/@ag;Table[K->aw[[w,2]],{K,ag[[1]],ag[[2]]}],{w,Length[aw]}]]];aB=Framed[TableForm[Table[ag=az[k,n];ag2=ay[k,n];aC=ToString[ag];aD=If[ag2>0,"+",""]<>ToString[Ceiling[ag2,0.01]]<>"\[Cent]";If[ag2==0.,aC="["<>ToString[ag]<>"Hz]";aD=""];If[ag>at,"",With[{a7=ag},Button[Row[{Style[aC,If[ag2==0,Blue,If[aw[k]==n,Red,Black]]],Style[aD,If[aw[k]==n,Pink,Gray],6]}],a4[a7],Appearance->None]]],{k,R[[1]],R[[2]]},{n,1,16}],TableHeadings->{Table[W[k],{k,R[[1]],R[[2]]}],Table[w,{w,1,16}]},TableSpacing->{.5,.3}]];a3=Framed[Column[{an,aq,D}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],a3];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],aB];];Column[{aB,Deploy[a3]}]]