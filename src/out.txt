packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",A4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[au_,OptionsPattern[]]:=Module[{aK,aV,y,b5,aj,aa,aP,bi,aO,e,af,aR,a2,bl,be,h,aN,aM,aG,b9,a9,aX,aE,a4,u,k,aW,b0,o,at,a5,aJ,bm,b,a6,ab,bf,b2,bj,ac,bh,w,aY,l,aA,b8,aT,ah,x,a,aB,bb,b6,z,i,aw,v,t,am,aD,aq,aS,a3,m,bc,ba,c,aQ,n,b3,aI,ap,ai,ak,av,b7,aH,az,ae,b1,ar,a8,f,j,bp,ag,g,aU,r,bn,al,aL,d,a0,an,a7,aF,p,a1,bd,aZ,ay,b4,s,ad,bk},u=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];ac=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];f={False,True,False,False,True,False,True,False,False,True,False,True};a4[q_]:=If[StringContainsQ[q,"#"],u[ToUpperCase[StringTake[q,2]]]+12*ToExpression[StringDrop[q,2]]-9,u[ToUpperCase[StringTake[q,1]]]+12*ToExpression[StringDrop[q,1]]-9];bm[q_]:=ac[Mod[q+9,12]]<>ToString[Floor[(q+9)/12]];aJ[q_]:=OptionValue[A4Frequency]*2^((q-48)/12);b[q_]:=f[[Mod[q,12]+1]];o=OptionValue[noteRange];b0=a4/@o;a5=OptionValue[noteStart];at=a4[a5]+1;bi[q_]:=1200.*Log[2,q];aO[q_]:=12.*Log[2,q];c=au;If[StringTake[au,-1]!="/",aF=True;Goto[p],aF=False];ak=Import[c];k=First[StringSplit[#,"."]]&/@ak;aW=If[LetterQ[StringTake[#,1]],a4[#],ToExpression[#]-at]&/@k;aR=0.9;w=0.05;aS=0.08;v=10000;am[q_]:=Which[q<40,17,q<60,13,True,8];a3=0.08;n=0.8;m=0.01;aK[e_,bo_]:=(aD=aQ[[Round[e-a3*bo];;Round[e+a3*bo]]];aE=a3+m;aq=aQ[[Round[e-aE*bo];;Round[e+aE*bo]]];y=First@First@Position[aq[[;;,2]],Max[aD[[;;,2]]]];a8=aq[[Round[y-m*bo];;Round[y+m*bo]]];a8=Total[Table[a8[[as,1]]*a8[[as,2]],{as,Length[a8]}]]/Total[Table[a8[[as,2]],{as,Length[a8]}]];a8);ab[q_]:=(ai=Import[c<>ak[[q]],"Sound"];ap=aJ[aW[[q]]];b1=ai[[1,2]];ba=Mean[ai[[1,1]]];ba=ba/Max[ba];ba=ba[[First[First[Position[ba,1.]]];;]];b7=Partition[ba,Floor[aS*b1]];aH=Length[b7];as=1;ar={};While[Max[Abs[b7[[as]]]]>=aR&&as<=aH;as++];While[Max[Abs[b7[[as]]]]>=w&&as<=aH,AppendTo[ar,b7[[as]]];as++];ar=Flatten[ar];t=am[aW[[q]]]+1;aQ=Abs[Fourier[ar]];aQ=Table[{as*b1/Length[ar],aQ[[as]]},{as,IntegerPart[Length[aQ]/2]}];bc=Min[ap*t,v];aQ=Select[aQ,First[#]<bc&];aQ=Table[{aQ[[as,1]]/ap,aQ[[as,2]]},{as,Length[aQ]}];av=ap/b1*Length[ar];b3=Round[n*av];ae=First@First@Position[aQ[[;;,2]],Max[aQ[[b3;;,2]]]];az=aQ[[ae,1]];b2={};aI=ae/Round[az];a6=ae/az;b5=az;aj=ae;af=aI;b2=Union[Append[b2,aK[aj,af]]];While[aj+af+(a3+m)*af<Length[aQ],e=aj+af;aV=aK[e,af];af=Round[(aV-b5)*a6];b5=aV;aj=Round[aV*a6];b2=Union[Append[b2,aV]];];If[Round[az]!=1,b5=az;aj=ae;While[aj-aI-(a3+m)>n*a6,e=aj-aI;aV=aK[e,a6];b5=aV;aj=Round[aV*a6];b2=Union[Prepend[b2,aV]];]];aW[[q]]->b2);bj=Association[ParallelTable[ab[as],{as,Length[aW]}]];Label[p];a2=10^4;If[!aF,aG=SortBy[Table[aP=bj[aW[[as]]];aP=aP/aP[[1]];Clear[aC,n];aP=Table[{as-1,aP[[as]]/as},{as,Length[aP]}];Flatten@{aW[[as]],a2*aC/.FindFit[aP,bg*Sqrt[1+aC*n^2],{{bg,1},{aC,0}},n]},{as,Length[aW]}],First];aM=Select[aG,Last[#]>0&];aM=Table[{aM[[as,1]],Log[aM[[as,2]]]},{as,Length[aM]}];aa=OptionValue[deleteNotes];aa=If[StringQ[#],a4[#],#-at]&/@aa;aM=Select[aM,!MemberQ[aa,#[[1]]]&];a1=StringRiffle[Table[bm[aM[[as,1]]]<>"  "<>ToString[aM[[as,2]]],{as,Length[aM]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],a1,"Text"]],a1=Import[au,"Text"];aT=StringSplit[#]&/@StringSplit[a1,"\n"];aM=Table[{a4[aT[[as,1]]],ToExpression[aT[[as,2]]]},{as,Length[aT]}];];h[aM_]:=(aT=aM[[;;,1]];bh=Fit[Select[aM,#[[1]]<=15&],{1,q},q];bh=(aM[[1,2]]-CoefficientList[bh,q][[-1]]*aM[[1,1]])+CoefficientList[bh,q][[-1]]*q;aX=Fit[Select[aM,#[[1]]>=40&],{1,q},q];aX=(aM[[-1,2]]-CoefficientList[aX,q][[-1]]*aM[[-1,1]])+CoefficientList[aX,q][[-1]]*q;b9=Flatten[{Table[{q,bh},{q,b0[[1]]-100,aT[[1]]-1,12}],aM,Table[{q,aX},{q,aT[[-1]]+1,b0[[2]]+100,12}]},1];a9=Interpolation[b9];aN=Show[Plot[a9[k],{k,b0[[1]],b0[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[b[aM[[as,1]]],Black,Pink],If[b[aM[[as,1]]],PointSize[.006],PointSize[.008]],Point[aM[[as]]]},{as,Length[aM]}],Black,Table[Text[bm[aM[[as,1]]],{aM[[as,1]],aM[[as,2]]+0.3If[OddQ[aM[[as,1]]],1,-1]},Background->White],{as,Length[aM]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[as,{as,b0[[1]],b0[[2]]}],Table[as,{as,-100,100}]},GridLinesStyle->LightRed];bl[k_,n_]:=n*Sqrt[1+E^a9[k]/a2*(n-1)^2];bl);be=h[aM];d=16000;z=OptionValue[polynomialOrder];aw=Table[ToExpression["X"<>ToString[as]],{as,z}];Clear/@aw;i[q_]=Expand[Total[Table[aw[[as]]*(q-a4["A4"])^as,{as,z}]]];bb=OptionValue[tuningMethod];j=OptionValue[tuningSplit];bb=Table[Sort[ToExpression[StringSplit[bb[[as]],":"]]],{as,Length[bb]}];j=a4@j;bp=bb[[1,2]]/bb[[1,1]];ag=aO[bp];r=Expand[Total[Table[bf=bi[be[ao,bb[[1,2]]]/be[ao+ag,bb[[1,1]]]/bp];(bf-(i[ao+ag]-i[ao]))^2,{ao,b0[[1]],j}]]];g=bb[[2,2]]/bb[[2,1]];aU=aO[g];bn=Expand[Total[Table[bf=bi[be[ao-aU,bb[[2,2]]]/be[ao,bb[[2,1]]]/g];(bf-(i[ao]-i[ao-aU]))^2,{ao,j+1,b0[[2]]}]]];a=r+bn;b6=NMinimize[a,aw];x[q_]=i[q]/.(b6[[2]]);aB=Graphics[Flatten[{LightRed,Line[{{b0[[1]],0},{b0[[2]],0}}],Table[{If[Mod[q-3,12]==0,{GrayLevel[.4],Disk[{q,x[q]},.6]}],If[b[q],Black,If[q==48,Red,LightGray]],Disk[{q,x[q]},If[b[q],.22,.33]]},{q,b0[[1]],b0[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[as,{as,b0[[1]],b0[[2]]}],Table[as,{as,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];al=-Flatten[{Table[bf=bi[be[ao,bb[[1,2]]]/be[ao+ag,bb[[1,1]]]/bp];(bf-(i[ao+ag]-i[ao]))/.b6[[2]],{ao,b0[[1]],j}],Table[bf=bi[be[ao-aU,bb[[2,2]]]/be[ao,bb[[2,1]]]/g];(bf-(i[ao]-i[ao-aU]))/.b6[[2]],{ao,j+1,b0[[2]]}]}];aL=Graphics[Flatten[{LightRed,Line[{{b0[[1]],0},{b0[[2]],0}}],Table[{If[Mod[q-3,12]==0,{GrayLevel[.4],Disk[{q,al[[q+1]]},.6]}],If[b[q],Black,If[q==48,Red,LightGray]],Disk[{q,al[[q+1]]},If[b[q],.22,.33]]},{q,b0[[1]],b0[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[as,{as,b0[[1]],b0[[2]]}],Table[as,{as,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];b8=OptionValue[temperment];If[b8!="",If[!DirectoryQ[b8],b8=packageDirectory<>"../res/temperments/"<>b8<>".tem"];aY=Import[b8,"Text"];aA=Map[StringSplit,StringSplit[aY,"\n"]];l=SortBy[Union@Table[{u[aA[[as,1]]],aA[[as,2]]},{as,Length[aA]}],First][[;;,2]];l=ToExpression/@l;ah[aY_,q_]:=(aT=RotateRight[l,u[q]];aT-aT[[10]]);l=ah[l,OptionValue[tempermentMajor]];aT=RotateRight[l,3];bd=Association[Table[as->aT[[as+1]],{as,0,11}]];,bd=Association[Table[as->0,{as,0,11}]];];aZ[k_,n_]:=(aJ[k]*2^((x[k]+bd[Mod[k,12]])/1200)*be[k,n]);ay[k_,n_]:=Log[2,aZ[k,n]/aJ[k]/n]*1200;a7[q_]:=EmitSound[Play[Sin[2*Pi*t*q],{t,0,0.2},SampleRate->44100]];a0=Import[packageDirectory<>"params/"<>"tuning_partials"];a0=Association[Flatten[Table[aT=StringSplit[a0[[as,1]],"~"];If[aT[[1]]=="*",aT[[1]]=o[[1]]];If[aT[[2]]=="*",aT[[2]]=o[[2]]];aT=a4/@aT;Table[ao->a0[[as,2]],{ao,aT[[1]],aT[[2]]}],{as,Length[a0]}]]];an=Framed[TableForm[Table[aT=aZ[k,n];b4=ay[k,n];s=ToString[aT];ad=If[b4>0,"+",""]<>ToString[Ceiling[b4,0.01]]<>"\[Cent]";If[b4==0.,s="["<>ToString[aT]<>"Hz]";ad=""];If[aT>d,"",With[{ax=aT},Button[Row[{Style[s,If[b4==0,Blue,If[a0[k]==n,Red,Black]]],Style[ad,If[a0[k]==n,Pink,Gray],6]}],a7[ax],Appearance->None]]],{k,b0[[1]],b0[[2]]},{n,1,16}],TableHeadings->{Table[bm[k],{k,b0[[1]],b0[[2]]}],Table[as,{as,1,16}]},TableSpacing->{.5,.3}]];bk=Framed[Column[{aB,aL,aN}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],bk];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],an];];Column[{an,Deploy[bk]}]]