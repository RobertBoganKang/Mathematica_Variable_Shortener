packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",A4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[aM_,OptionsPattern[]]:=Module[{at,v,aT,ah,q,aC,z,an,aZ,r,a5,bp,aG,bd,p,bl,b9,c,br,b5,aV,ao,aP,u,am,bn,a2,d,av,aW,bb,az,ap,a7,ad,ba,a1,w,i,bk,ag,bi,aU,a8,ay,a9,e,b6,aD,s,bh,l,ax,aQ,o,aB,b7,bc,bq,k,aY,j,af,ae,b4,y,aL,h,aI,bm,aA,aq,b1,aS,be,al,aO,ac,ab,ar,a3,a0,bj,a4,aw,aj,au,ai,bo,b2,aH,bf,bg,a6,aF,n,aR,b8,as,aJ,aE,b3,ak,aN,aK,aX},am=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];bk=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];bj={False,True,False,False,True,False,True,False,False,True,False,True};u[b_]:=If[StringContainsQ[b,"#"],am[ToUpperCase[StringTake[b,2]]]+12*ToExpression[StringDrop[b,2]]-9,am[ToUpperCase[StringTake[b,1]]]+12*ToExpression[StringDrop[b,1]]-9];ap[b_]:=bk[Mod[b+9,12]]<>ToString[Floor[(b+9)/12]];az[b_]:=OptionValue[A4Frequency]*2^((b-48)/12);a7[b_]:=bj[[Mod[b,12]+1]];av=OptionValue[noteRange];d=u/@av;bb=OptionValue[noteStart];aW=u[bb]+1;an[b_]:=1200.*Log[2,b];aZ[b_]:=12.*Log[2,b];aL=aM;If[StringTake[aM,-1]!="/",aR=True;Goto[b8],aR=False];aS=Import[aL];bn=First[StringSplit[#,"."]]&/@aS;a2=If[LetterQ[StringTake[#,1]],u[#],ToExpression[#]-aW]&/@bn;bp=0.9;bi=0.05;j=0.08;b7=10000;bq[b_]:=Which[b<40,17,b<60,13,True,8];af=0.08;aI=0.8;ae=0.01;at[r_,aa_]:=(k=h[[Round[r-af*aa];;Round[r+af*aa]]];aP=af+ae;aY=h[[Round[r-aP*aa];;Round[r+aP*aa]]];aT=First@First@Position[aY[[;;,2]],Max[k[[;;,2]]]];a0=aY[[Round[aT-ae*aa];;Round[aT+ae*aa]]];a0=Total[Table[a0[[a,1]]*a0[[a,2]],{a,Length[a0]}]]/Total[Table[a0[[a,2]],{a,Length[a0]}]];a0);ba[b_]:=(b1=Import[aL<>aS[[b]],"Sound"];aq=az[a2[[b]]];ar=b1[[1,2]];y=Mean[b1[[1,1]]];y=y/Max[y];y=y[[First[First[Position[y,1.]]];;]];al=Partition[y,Floor[j*ar]];aO=Length[al];a=1;a3={};While[Max[Abs[al[[a]]]]>=bp&&a<=aO;a++];While[Max[Abs[al[[a]]]]>=bi&&a<=aO,AppendTo[a3,al[[a]]];a++];a3=Flatten[a3];bc=bq[a2[[b]]]+1;h=Abs[Fourier[a3]];h=Table[{a*ar/Length[a3],h[[a]]},{a,IntegerPart[Length[h]/2]}];b4=Min[aq*bc,b7];h=Select[h,First[#]<b4&];h=Table[{h[[a,1]]/aq,h[[a,2]]},{a,Length[h]}];be=aq/ar*Length[a3];bm=Round[aI*be];ab=First@First@Position[h[[;;,2]],Max[h[[bm;;,2]]]];ac=h[[ab,1]];w={};aA=ab/Round[ac];ad=ab/ac;ah=ac;q=ab;a5=aA;w=Union[Append[w,at[q,a5]]];While[q+a5+(af+ae)*a5<Length[h],r=q+a5;v=at[r,a5];a5=Round[(v-ah)*ad];ah=v;q=Round[v*ad];w=Union[Append[w,v]];];If[Round[ac]!=1,ah=ac;q=ab;While[q-aA-(af+ae)>aI*ad,r=q-aA;v=at[r,ad];ah=v;q=Round[v*ad];w=Union[Prepend[w,v]];]];a2[[b]]->w);i=Association[ParallelTable[ba[a],{a,Length[a2]}]];Label[b8];aG=10^4;If[!aR,br=SortBy[Table[z=i[a2[[a]]];z=z/z[[1]];Clear[b0,m];z=Table[{a-1,z[[a]]/a},{a,Length[z]}];Flatten@{a2[[a]],aG*b0/.FindFit[z,x*Sqrt[1+b0*m^2],{{x,1},{b0,0}},m]},{a,Length[a2]}],First];c=Select[br,Last[#]>0&];c=Table[{c[[a,1]],Log[c[[a,2]]]},{a,Length[c]}];aC=OptionValue[deleteNotes];aC=If[StringQ[#],u[#],#-aW]&/@aC;c=Select[c,!MemberQ[aC,#[[1]]]&];as=StringRiffle[Table[ap[c[[a,1]]]<>"  "<>ToString[c[[a,2]]],{a,Length[c]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],as,"Text"]],as=Import[aM,"Text"];e=StringSplit[#]&/@StringSplit[as,"\n"];c=Table[{u[e[[a,1]]],ToExpression[e[[a,2]]]},{a,Length[e]}];];bl[c_]:=(e=c[[;;,1]];ag=Fit[Select[c,#[[1]]<=15&],{1,b},b];ag=(c[[1,2]]-CoefficientList[ag,b][[-1]]*c[[1,1]])+CoefficientList[ag,b][[-1]]*b;ao=Fit[Select[c,#[[1]]>=40&],{1,b},b];ao=(c[[-1,2]]-CoefficientList[ao,b][[-1]]*c[[-1,1]])+CoefficientList[ao,b][[-1]]*b;b5=Flatten[{Table[{b,ag},{b,d[[1]]-100,e[[1]]-1,12}],c,Table[{b,ao},{b,e[[-1]]+1,d[[2]]+100,12}]},1];aV=Interpolation[b5];b9=Show[Plot[aV[g],{g,d[[1]],d[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[a7[c[[a,1]]],Black,Pink],If[a7[c[[a,1]]],PointSize[.006],PointSize[.008]],Point[c[[a]]]},{a,Length[c]}],Black,Table[Text[ap[c[[a,1]]],{c[[a,1]],c[[a,2]]+0.3If[OddQ[c[[a,1]]],1,-1]},Background->White],{a,Length[c]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightRed];bd[g_,m_]:=m*Sqrt[1+E^aV[g]/aG*(m-1)^2];bd);p=bl[c];bg=16000;aQ=OptionValue[polynomialOrder];aB=Table[ToExpression["X"<>ToString[a]],{a,aQ}];Clear/@aB;o[b_]=Expand[Total[Table[aB[[a]]*(b-u["A4"])^a,{a,aQ}]]];l=OptionValue[tuningMethod];a4=OptionValue[tuningSplit];l=Table[Sort[ToExpression[StringSplit[l[[a]],":"]]],{a,Length[l]}];a4=u@a4;aw=l[[1,2]]/l[[1,1]];aj=aZ[aw];bo=Expand[Total[Table[a1=an[p[f,l[[1,2]]]/p[f+aj,l[[1,1]]]/aw];(a1-(o[f+aj]-o[f]))^2,{f,d[[1]],a4}]]];au=l[[2,2]]/l[[2,1]];ai=aZ[au];b2=Expand[Total[Table[a1=an[p[f-ai,l[[2,2]]]/p[f,l[[2,1]]]/au];(a1-(o[f]-o[f-ai]))^2,{f,a4+1,d[[2]]}]]];s=bo+b2;ax=NMinimize[s,aB];aD[b_]=o[b]/.(ax[[2]]);bh=Graphics[Flatten[{LightRed,Line[{{d[[1]],0},{d[[2]],0}}],Table[{If[Mod[b-3,12]==0,{GrayLevel[.4],Disk[{b,aD[b]},.6]}],If[a7[b],Black,If[b==48,Red,LightGray]],Disk[{b,aD[b]},If[a7[b],.22,.33]]},{b,d[[1]],d[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];aH=-Flatten[{Table[a1=an[p[f,l[[1,2]]]/p[f+aj,l[[1,1]]]/aw];(a1-(o[f+aj]-o[f]))/.ax[[2]],{f,d[[1]],a4}],Table[a1=an[p[f-ai,l[[2,2]]]/p[f,l[[2,1]]]/au];(a1-(o[f]-o[f-ai]))/.ax[[2]],{f,a4+1,d[[2]]}]}];bf=Graphics[Flatten[{LightRed,Line[{{d[[1]],0},{d[[2]],0}}],Table[{If[Mod[b-3,12]==0,{GrayLevel[.4],Disk[{b,aH[[b+1]]},.6]}],If[a7[b],Black,If[b==48,Red,LightGray]],Disk[{b,aH[[b+1]]},If[a7[b],.22,.33]]},{b,d[[1]],d[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];a9=OptionValue[temperment];If[a9!="",If[!DirectoryQ[a9],a9=packageDirectory<>"../res/temperments/"<>a9<>".tem"];aU=Import[a9,"Text"];ay=Map[StringSplit,StringSplit[aU,"\n"]];a8=SortBy[Union@Table[{am[ay[[a,1]]],ay[[a,2]]},{a,Length[ay]}],First][[;;,2]];a8=ToExpression/@a8;b6[aU_,b_]:=(e=RotateRight[a8,am[b]];e-e[[10]]);a8=b6[a8,OptionValue[tempermentMajor]];e=RotateRight[a8,3];aJ=Association[Table[a->e[[a+1]],{a,0,11}]];,aJ=Association[Table[a->0,{a,0,11}]];];aE[g_,m_]:=(az[g]*2^((aD[g]+aJ[Mod[g,12]])/1200)*p[g,m]);b3[g_,m_]:=Log[2,aE[g,m]/az[g]/m]*1200;n[b_]:=EmitSound[Play[Sin[2*Pi*t*b],{t,0,0.2},SampleRate->44100]];a6=Import[packageDirectory<>"params/"<>"tuning_partials"];a6=Association[Flatten[Table[e=StringSplit[a6[[a,1]],"~"];If[e[[1]]=="*",e[[1]]=av[[1]]];If[e[[2]]=="*",e[[2]]=av[[2]]];e=u/@e;Table[f->a6[[a,2]],{f,e[[1]],e[[2]]}],{a,Length[a6]}]]];aF=Framed[TableForm[Table[e=aE[g,m];ak=b3[g,m];aN=ToString[e];aK=If[ak>0,"+",""]<>ToString[Ceiling[ak,0.01]]<>"\[Cent]";If[ak==0.,aN="["<>ToString[e]<>"Hz]";aK=""];If[e>bg,"",With[{t=e},Button[Row[{Style[aN,If[ak==0,Blue,If[a6[g]==m,Red,Black]]],Style[aK,If[a6[g]==m,Pink,Gray],6]}],n[t],Appearance->None]]],{g,d[[1]],d[[2]]},{m,1,16}],TableHeadings->{Table[ap[g],{g,d[[1]],d[[2]]}],Table[a,{a,1,16}]},TableSpacing->{.5,.3}]];aX=Framed[Column[{bh,bf,b9}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],aX];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],aF];];Column[{aF,Deploy[aX]}]]