packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",a4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[m_,OptionsPattern[]]:=Module[{c,d,e,f,g,h,l,o,p,q,u,v,y,K,z,D,F,G,G0,G2,J,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,a0,a1,a2,a3,a7,a9,aa,ab,ac,ad,af,ah,ag,am,an,ao,bw,bx,bz,bI,bJ,bK,bL,bM,bN,bO,bP,bQ,bR,bS,bT,bU,bV,bW,bX,bY,bZ,b0,b1,b2,b3,b4,b5,b6,b7,b8,b9,ba,bC,aj,ak,bG,bH,al,ap,aq,ar,bv,by,bD,a5,bt,a6,bu,ae,bB,bA,ah2,bE,bF,a4},P=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];a7=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];ba={False,True,False,False,True,False,True,False,False,True,False,True};O[bb_]:=If[StringContainsQ[bb,"#"],P[ToUpperCase[StringTake[bb,2]]]+12*ToExpression[StringDrop[bb,2]]-9,P[ToUpperCase[StringTake[bb,1]]]+12*ToExpression[StringDrop[bb,1]]-9];X[bb_]:=a7[Mod[bb+9,12]]<>ToString[Floor[(bb+9)/12]];W[bb_]:=OptionValue[a4Frequency]*2^((bb-48)/12);Y[bb_]:=ba[[Mod[bb,12]+1]];T=OptionValue[noteRange];S=O/@T;V=OptionValue[noteStart];U=O[V]+1;o[bb_]:=1200.*Log[2,bb];p[bb_]:=12.*Log[2,bb];bU=m;If[StringTake[m,-1]!="/",bt=True;Goto[a6],bt=False];b1=Import[bU];Q=First[StringSplit[#,"."]]&/@b1;R=If[LetterQ[StringTake[#,1]],O[#],ToExpression[#]-U]&/@Q;v=0.9;aa=0.05;bP=0.08;bK=10000;bM[bb_]:=Which[bb<40,17,bb<60,13,True,8];bQ=0.08;bW=0.8;bR=0.01;c[q_,r_]:=(bN=bV[[Round[q-bQ*r];;Round[q+bQ*r]]];N=bQ+bR;bO=bV[[Round[q-N*r];;Round[q+N*r]]];e=First@First@Position[bO[[;;,2]],Max[bN[[;;,2]]]];b9=bO[[Round[e-bR*r];;Round[e+bR*r]]];b9=Total[Table[b9[[w,1]]*b9[[w,2]],{w,Length[b9]}]]/Total[Table[b9[[w,2]],{w,Length[b9]}]];b9);a0[bb_]:=(b0=Import[bU<>b1[[bb]],"Sound"];bZ=W[R[[bb]]];b7=b0[[1,2]];bT=Mean[b0[[1,1]]];bT=bT/Max[bT];bT=bT[[First[First[Position[bT,1.]]];;]];b3=Partition[bT,Floor[bP*b7]];b4=Length[b3];w=1;b8={};While[Max[Abs[b3[[w]]]]>=v&&w<=b4;w++];While[Max[Abs[b3[[w]]]]>=aa&&w<=b4,AppendTo[b8,b3[[w]]];w++];b8=Flatten[b8];bL=bM[R[[bb]]]+1;bV=Abs[Fourier[b8]];bV=Table[{w*b7/Length[b8],bV[[w]]},{w,IntegerPart[Length[bV]/2]}];bS=Min[bZ*bL,bK];bV=Select[bV,First[#]<bS&];bV=Table[{bV[[w,1]]/bZ,bV[[w,2]]},{w,Length[bV]}];b2=bZ/b7*Length[b8];bX=Round[bW*b2];b6=First@First@Position[bV[[;;,2]],Max[bV[[bX;;,2]]]];b5=bV[[b6,1]];a2={};bY=b6/Round[b5];Z=b6/b5;f=b5;g=b6;u=bY;a2=Union[Append[a2,c[g,u]]];While[g+u+(bQ+bR)*u<Length[bV],q=g+u;d=c[q,u];u=Round[(d-f)*Z];f=d;g=Round[d*Z];a2=Union[Append[a2,d]];];If[Round[b5]!=1,f=b5;g=b6;While[g-bY-(bQ+bR)>bW*Z,q=g-bY;d=c[q,Z];f=d;g=Round[d*Z];a2=Union[Prepend[a2,d]];]];R[[bb]]->a2);a3=Association[ParallelTable[a0[w],{w,Length[R]}]];Label[a6];y=10^4;If[!bt,G0=SortBy[Table[l=a3[R[[w]]];l=l/l[[1]];Clear[b,n];l=Table[{w-1,l[[w]]/w},{w,Length[l]}];Flatten@{R[[w]],y*b/.FindFit[l,a*Sqrt[1+b*n^2],{{a,1},{b,0}},n]},{w,Length[R]}],First];G=Select[G0,Last[#]>0&];G=Table[{G[[w,1]],Log[G[[w,2]]]},{w,Length[G]}];h=OptionValue[deleteNotes];h=If[StringQ[#],O[#],#-U]&/@h;G=Select[G,!MemberQ[h,#[[1]]]&];bu=StringRiffle[Table[X[G[[w,1]]]<>"  "<>ToString[G[[w,2]]],{w,Length[G]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],bu,"Text"]],bu=Import[m,"Text"];ah=StringSplit[#]&/@StringSplit[bu,"\n"];G=Table[{O[ah[[w,1]]],ToExpression[ah[[w,2]]]},{w,Length[ah]}];];D[G_]:=(ah=G[[;;,1]];a9=Fit[Select[G,#[[1]]<=15&],{1,bb},bb];a9=(G[[1,2]]-CoefficientList[a9,bb][[-1]]*G[[1,1]])+CoefficientList[a9,bb][[-1]]*bb;M=Fit[Select[G,#[[1]]>=40&],{1,bb},bb];M=(G[[-1,2]]-CoefficientList[M,bb][[-1]]*G[[-1,1]])+CoefficientList[M,bb][[-1]]*bb;G2=Flatten[{Table[{bb,a9},{bb,S[[1]]-100,ah[[1]]-1,12}],G,Table[{bb,M},{bb,ah[[-1]]+1,S[[2]]+100,12}]},1];J=Interpolation[G2];F=Show[Plot[J[k],{k,S[[1]],S[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[Y[G[[w,1]]],Black,Pink],If[Y[G[[w,1]]],PointSize[.006],PointSize[.008]],Point[G[[w]]]},{w,Length[G]}],Black,Table[Text[X[G[[w,1]]],{G[[w,1]],G[[w,2]]+0.3If[OddQ[G[[w,1]]],1,-1]},Background->White],{w,Length[G]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[w,{w,S[[1]],S[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightRed];K[k_,n_]:=n*Sqrt[1+E^J[k]/y*(n-1)^2];K);z=D[G];bv=16000;bz=OptionValue[polynomialOrder];bJ=Table[ToExpression["X"<>ToString[w]],{w,bz}];Clear/@bJ;bI[bb_]=Expand[Total[Table[bJ[[w]]*(bb-O["A4"])^w,{w,bz}]]];bw=OptionValue[tuningMethod];bC=OptionValue[tuningSplit];bw=Table[Sort[ToExpression[StringSplit[bw[[w]],":"]]],{w,Length[bw]}];bC=O@bC;aj=bw[[1,2]]/bw[[1,1]];ak=p[aj];al=Expand[Total[Table[a1=o[z[L,bw[[1,2]]]/z[L+ak,bw[[1,1]]]/aj];(a1-(bI[L+ak]-bI[L]))^2,{L,S[[1]],bC}]]];bG=bw[[2,2]]/bw[[2,1]];bH=p[bG];ap=Expand[Total[Table[a1=o[z[L-bH,bw[[2,2]]]/z[L,bw[[2,1]]]/bG];(a1-(bI[L]-bI[L-bH]))^2,{L,bC+1,S[[2]]}]]];an=al+ap;bx=NMinimize[an,bJ];am[bb_]=bI[bb]/.(bx[[2]]);ao=Graphics[Flatten[{LightRed,Line[{{S[[1]],0},{S[[2]],0}}],Table[{If[Mod[bb-3,12]==0,{GrayLevel[.4],Disk[{bb,am[bb]},.6]}],If[Y[bb],Black,If[bb==48,Red,LightGray]],Disk[{bb,am[bb]},If[Y[bb],.22,.33]]},{bb,S[[1]],S[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[w,{w,S[[1]],S[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];aq=-Flatten[{Table[a1=o[z[L,bw[[1,2]]]/z[L+ak,bw[[1,1]]]/aj];(a1-(bI[L+ak]-bI[L]))/.bx[[2]],{L,S[[1]],bC}],Table[a1=o[z[L-bH,bw[[2,2]]]/z[L,bw[[2,1]]]/bG];(a1-(bI[L]-bI[L-bH]))/.bx[[2]],{L,bC+1,S[[2]]}]}];ar=Graphics[Flatten[{LightRed,Line[{{S[[1]],0},{S[[2]],0}}],Table[{If[Mod[bb-3,12]==0,{GrayLevel[.4],Disk[{bb,aq[[bb+1]]},.6]}],If[Y[bb],Black,If[bb==48,Red,LightGray]],Disk[{bb,aq[[bb+1]]},If[Y[bb],.22,.33]]},{bb,S[[1]],S[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[w,{w,S[[1]],S[[2]]}],Table[w,{w,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];af=OptionValue[temperment];If[af!="",If[!DirectoryQ[af],af=packageDirectory<>"../res/temperments/"<>af<>".tem"];ab=Import[af,"Text"];ad=Map[StringSplit,StringSplit[ab,"\n"]];ac=SortBy[Union@Table[{P[ad[[w,1]]],ad[[w,2]]},{w,Length[ad]}],First][[;;,2]];ac=ToExpression/@ac;ag[ab_,bb_]:=(ah=RotateRight[ac,P[bb]];ah-ah[[10]]);ac=ag[ac,OptionValue[tempermentMajor]];ah=RotateRight[ac,3];ae=Association[Table[w->ah[[w+1]],{w,0,11}]];,ae=Association[Table[w->0,{w,0,11}]];];bB[k_,n_]:=(W[k]*2^((am[k]+ae[Mod[k,12]])/1200)*z[k,n]);bA[k_,n_]:=Log[2,bB[k,n]/W[k]/n]*1200;a5[bb_]:=EmitSound[Play[Sin[2*Pi*t*bb],{t,0,0.2},SampleRate->44100]];by=Import[packageDirectory<>"params/"<>"tuning_partials"];by=Association[Flatten[Table[ah=StringSplit[by[[w,1]],"~"];If[ah[[1]]=="*",ah[[1]]=T[[1]]];If[ah[[2]]=="*",ah[[2]]=T[[2]]];ah=O/@ah;Table[L->by[[w,2]],{L,ah[[1]],ah[[2]]}],{w,Length[by]}]]];bD=Framed[TableForm[Table[ah=bB[k,n];ah2=bA[k,n];bE=ToString[ah];bF=If[ah2>0,"+",""]<>ToString[Ceiling[ah2,0.01]]<>"\[Cent]";If[ah2==0.,bE="["<>ToString[ah]<>"Hz]";bF=""];If[ah>bv,"",With[{a8=ah},Button[Row[{Style[bE,If[ah2==0,Blue,If[by[k]==n,Red,Black]]],Style[bF,If[by[k]==n,Pink,Gray],6]}],a5[a8],Appearance->None]]],{k,S[[1]],S[[2]]},{n,1,16}],TableHeadings->{Table[X[k],{k,S[[1]],S[[2]]}],Table[w,{w,1,16}]},TableSpacing->{.5,.3}]];a4=Framed[Column[{ao,ar,F}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],a4];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],bD];];Column[{bD,Deploy[a4]}]]