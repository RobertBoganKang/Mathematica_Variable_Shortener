packageDirectory=NotebookDirectory[];Options[pianoTuner]={noteRange->{"A0","C8"},deleteNotes->{},noteStart->"A0",tuningSplit->"C#4",tuningMethod->{"6:3","4:1"},polynomialOrder->7,temperment->"",tempermentMajor->"C",A4Frequency->440,saveTuningFile->"",reportFormat->"pdf"};pianoTuner[aW_,OptionsPattern[]]:=Module[{aC,v,aI,ai,u,aD,a0,ag,aM,r,a5,bn,aH,n,o,bs,bj,c,b7,bc,aY,ao,aL,q,an,ba,w,d,ax,b0,be,aA,aw,a7,ae,br,a2,y,k,i,ak,j,aO,a8,av,af,e,bb,as,bq,bh,l,ap,aX,p,az,bk,bg,b2,bp,aU,b8,a9,ab,bl,a1,aT,h,b1,bm,at,aB,aG,aP,b6,aj,aR,aa,ad,aq,a3,z,bd,a6,ar,al,au,am,b9,b5,aS,bi,b4,a4,aE,b3,aN,bf,ay,aV,aZ,bo,ah,aJ,aQ,aF},an=Association["C"->0,"C#"->1,"D"->2,"D#"->3,"E"->4,"F"->5,"F#"->6,"G"->7,"G#"->8,"A"->9,"A#"->10,"B"->11];i=Association[0->"C",1->"C#",2->"D",3->"D#",4->"E",5->"F",6->"F#",7->"G",8->"G#",9->"A",10->"A#",11->"B"];bd={False,True,False,False,True,False,True,False,False,True,False,True};q[b_]:=If[StringContainsQ[b,"#"],an[ToUpperCase[StringTake[b,2]]]+12*ToExpression[StringDrop[b,2]]-9,an[ToUpperCase[StringTake[b,1]]]+12*ToExpression[StringDrop[b,1]]-9];aw[b_]:=i[Mod[b+9,12]]<>ToString[Floor[(b+9)/12]];aA[b_]:=OptionValue[A4Frequency]*2^((b-48)/12);a7[b_]:=bd[[Mod[b,12]+1]];ax=OptionValue[noteRange];d=q/@ax;be=OptionValue[noteStart];b0=q[be]+1;ag[b_]:=1200.*Log[2,b];aM[b_]:=12.*Log[2,b];aT=aW;If[StringTake[aW,-1]!="/",aN=True;Goto[bf],aN=False];aP=Import[aT];ba=First[StringSplit[#,"."]]&/@aP;w=If[LetterQ[StringTake[#,1]],q[#],ToExpression[#]-b0]&/@ba;bn=0.9;j=0.05;b8=0.08;bk=10000;b2[b_]:=Which[b<40,17,b<60,13,True,8];a9=0.08;b1=0.8;ab=0.01;aC[r_,ac_]:=(bp=h[[Round[r-a9*ac];;Round[r+a9*ac]]];aL=a9+ab;aU=h[[Round[r-aL*ac];;Round[r+aL*ac]]];aI=First@First@Position[aU[[;;,2]],Max[bp[[;;,2]]]];z=aU[[Round[aI-ab*ac];;Round[aI+ab*ac]]];z=Total[Table[z[[a,1]]*z[[a,2]],{a,Length[z]}]]/Total[Table[z[[a,2]],{a,Length[z]}]];z);br[b_]:=(aG=Import[aT<>aP[[b]],"Sound"];aB=aA[w[[b]]];aq=aG[[1,2]];a1=Mean[aG[[1,1]]];a1=a1/Max[a1];a1=a1[[First[First[Position[a1,1.]]];;]];aj=Partition[a1,Floor[b8*aq]];aR=Length[aj];a=1;a3={};While[Max[Abs[aj[[a]]]]>=bn&&a<=aR;a++];While[Max[Abs[aj[[a]]]]>=j&&a<=aR,AppendTo[a3,aj[[a]]];a++];a3=Flatten[a3];bg=b2[w[[b]]]+1;h=Abs[Fourier[a3]];h=Table[{a*aq/Length[a3],h[[a]]},{a,IntegerPart[Length[h]/2]}];bl=Min[aB*bg,bk];h=Select[h,First[#]<bl&];h=Table[{h[[a,1]]/aB,h[[a,2]]},{a,Length[h]}];b6=aB/aq*Length[a3];bm=Round[b1*b6];ad=First@First@Position[h[[;;,2]],Max[h[[bm;;,2]]]];aa=h[[ad,1]];y={};at=ad/Round[aa];ae=ad/aa;ai=aa;u=ad;a5=at;y=Union[Append[y,aC[u,a5]]];While[u+a5+(a9+ab)*a5<Length[h],r=u+a5;v=aC[r,a5];a5=Round[(v-ai)*ae];ai=v;u=Round[v*ae];y=Union[Append[y,v]];];If[Round[aa]!=1,ai=aa;u=ad;While[u-at-(a9+ab)>b1*ae,r=u-at;v=aC[r,ae];ai=v;u=Round[v*ae];y=Union[Prepend[y,v]];]];w[[b]]->y);k=Association[ParallelTable[br[a],{a,Length[w]}]];Label[bf];aH=10^4;If[!aN,b7=SortBy[Table[a0=k[w[[a]]];a0=a0/a0[[1]];Clear[aK,m];a0=Table[{a-1,a0[[a]]/a},{a,Length[a0]}];Flatten@{w[[a]],aH*aK/.FindFit[a0,x*Sqrt[1+aK*m^2],{{x,1},{aK,0}},m]},{a,Length[w]}],First];c=Select[b7,Last[#]>0&];c=Table[{c[[a,1]],Log[c[[a,2]]]},{a,Length[c]}];aD=OptionValue[deleteNotes];aD=If[StringQ[#],q[#],#-b0]&/@aD;c=Select[c,!MemberQ[aD,#[[1]]]&];ay=StringRiffle[Table[aw[c[[a,1]]]<>"  "<>ToString[c[[a,2]]],{a,Length[c]}],"\n"];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile],ay,"Text"]],ay=Import[aW,"Text"];e=StringSplit[#]&/@StringSplit[ay,"\n"];c=Table[{q[e[[a,1]]],ToExpression[e[[a,2]]]},{a,Length[e]}];];bs[c_]:=(e=c[[;;,1]];ak=Fit[Select[c,#[[1]]<=15&],{1,b},b];ak=(c[[1,2]]-CoefficientList[ak,b][[-1]]*c[[1,1]])+CoefficientList[ak,b][[-1]]*b;ao=Fit[Select[c,#[[1]]>=40&],{1,b},b];ao=(c[[-1,2]]-CoefficientList[ao,b][[-1]]*c[[-1,1]])+CoefficientList[ao,b][[-1]]*b;bc=Flatten[{Table[{b,ak},{b,d[[1]]-100,e[[1]]-1,12}],c,Table[{b,ao},{b,e[[-1]]+1,d[[2]]+100,12}]},1];aY=Interpolation[bc];bj=Show[Plot[aY[g],{g,d[[1]],d[[2]]},PlotRange->All,Axes->None,ImageSize->1600,Frame->True,AspectRatio->1/4,PlotStyle->Directive[Thick,Red],FrameLabel->{"Keys","Inharmonicity Value"}],Graphics[Flatten[{Table[{If[a7[c[[a,1]]],Black,Pink],If[a7[c[[a,1]]],PointSize[.006],PointSize[.008]],Point[c[[a]]]},{a,Length[c]}],Black,Table[Text[aw[c[[a,1]]],{c[[a,1]],c[[a,2]]+0.3If[OddQ[c[[a,1]]],1,-1]},Background->White],{a,Length[c]}]}]],FrameTicks->{None,Automatic},GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightRed];n[g_,m_]:=m*Sqrt[1+E^aY[g]/aH*(m-1)^2];n);o=bs[c];b4=16000;aX=OptionValue[polynomialOrder];az=Table[ToExpression["X"<>ToString[a]],{a,aX}];Clear/@az;p[b_]=Expand[Total[Table[az[[a]]*(b-q["A4"])^a,{a,aX}]]];l=OptionValue[tuningMethod];a6=OptionValue[tuningSplit];l=Table[Sort[ToExpression[StringSplit[l[[a]],":"]]],{a,Length[l]}];a6=q@a6;ar=l[[1,2]]/l[[1,1]];al=aM[ar];b9=Expand[Total[Table[a2=ag[o[f,l[[1,2]]]/o[f+al,l[[1,1]]]/ar];(a2-(p[f+al]-p[f]))^2,{f,d[[1]],a6}]]];au=l[[2,2]]/l[[2,1]];am=aM[au];b5=Expand[Total[Table[a2=ag[o[f-am,l[[2,2]]]/o[f,l[[2,1]]]/au];(a2-(p[f]-p[f-am]))^2,{f,a6+1,d[[2]]}]]];bq=b9+b5;ap=NMinimize[bq,az];as[b_]=p[b]/.(ap[[2]]);bh=Graphics[Flatten[{LightRed,Line[{{d[[1]],0},{d[[2]],0}}],Table[{If[Mod[b-3,12]==0,{GrayLevel[.4],Disk[{b,as[b]},.6]}],If[a7[b],Black,If[b==48,Red,LightGray]],Disk[{b,as[b]},If[a7[b],.22,.33]]},{b,d[[1]],d[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Tuning Curve (cents)"},FrameTicks->{None,Automatic}];aS=-Flatten[{Table[a2=ag[o[f,l[[1,2]]]/o[f+al,l[[1,1]]]/ar];(a2-(p[f+al]-p[f]))/.ap[[2]],{f,d[[1]],a6}],Table[a2=ag[o[f-am,l[[2,2]]]/o[f,l[[2,1]]]/au];(a2-(p[f]-p[f-am]))/.ap[[2]],{f,a6+1,d[[2]]}]}];bi=Graphics[Flatten[{LightRed,Line[{{d[[1]],0},{d[[2]],0}}],Table[{If[Mod[b-3,12]==0,{GrayLevel[.4],Disk[{b,aS[[b+1]]},.6]}],If[a7[b],Black,If[b==48,Red,LightGray]],Disk[{b,aS[[b+1]]},If[a7[b],.22,.33]]},{b,d[[1]],d[[2]]}]}],ImageSize->1600,Frame->True,GridLines->{Table[a,{a,d[[1]],d[[2]]}],Table[a,{a,-100,100}]},GridLinesStyle->LightBlue,FrameLabel->{None,"Deviation (cents)"},FrameTicks->{None,Automatic}];af=OptionValue[temperment];If[af!="",If[!DirectoryQ[af],af=packageDirectory<>"../res/temperments/"<>af<>".tem"];aO=Import[af,"Text"];av=Map[StringSplit,StringSplit[aO,"\n"]];a8=SortBy[Union@Table[{an[av[[a,1]]],av[[a,2]]},{a,Length[av]}],First][[;;,2]];a8=ToExpression/@a8;bb[aO_,b_]:=(e=RotateRight[a8,an[b]];e-e[[10]]);a8=bb[a8,OptionValue[tempermentMajor]];e=RotateRight[a8,3];aV=Association[Table[a->e[[a+1]],{a,0,11}]];,aV=Association[Table[a->0,{a,0,11}]];];aZ[g_,m_]:=(aA[g]*2^((as[g]+aV[Mod[g,12]])/1200)*o[g,m]);bo[g_,m_]:=Log[2,aZ[g,m]/aA[g]/m]*1200;b3[b_]:=EmitSound[Play[Sin[2*Pi*t*b],{t,0,0.2},SampleRate->44100]];a4=Import[packageDirectory<>"params/"<>"tuning_partials"];a4=Association[Flatten[Table[e=StringSplit[a4[[a,1]],"~"];If[e[[1]]=="*",e[[1]]=ax[[1]]];If[e[[2]]=="*",e[[2]]=ax[[2]]];e=q/@e;Table[f->a4[[a,2]],{f,e[[1]],e[[2]]}],{a,Length[a4]}]]];aE=Framed[TableForm[Table[e=aZ[g,m];ah=bo[g,m];aJ=ToString[e];aQ=If[ah>0,"+",""]<>ToString[Ceiling[ah,0.01]]<>"\[Cent]";If[ah==0.,aJ="["<>ToString[e]<>"Hz]";aQ=""];If[e>b4,"",With[{s=e},Button[Row[{Style[aJ,If[ah==0,Blue,If[a4[g]==m,Red,Black]]],Style[aQ,If[a4[g]==m,Pink,Gray],6]}],b3[s],Appearance->None]]],{g,d[[1]],d[[2]]},{m,1,16}],TableHeadings->{Table[aw[g],{g,d[[1]],d[[2]]}],Table[a,{a,1,16}]},TableSpacing->{.5,.3}]];aF=Framed[Column[{bh,bi,bj}]];If[OptionValue[saveTuningFile]!="",Export[packageDirectory<>OptionValue[saveTuningFile]<>" curve."<>OptionValue[reportFormat],aF];Export[packageDirectory<>OptionValue[saveTuningFile]<>" tuning."<>OptionValue[reportFormat],aE];];Column[{aE,Deploy[aF]}]]